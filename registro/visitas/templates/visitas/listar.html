{% extends 'visitas/base.html' %}

{% block title %}
  Lista de Visitas
{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto mt-12 p-8 bg-white rounded-xl shadow-md border border-pink-200">
    <h1 class="text-2xl font-bold mb-6 text-pink-600 text-center">Visitas Registradas</h1>

    <div class="mb-6 flex justify-between items-center">
      <a href="{% url 'visitas:inicio' %}" 
         class="text-pink-500 font-medium hover:underline">
        <i class="bi bi-house-door-fill"></i> Inicio
      </a>

      <form method="get" class="flex items-center gap-2">
        <label for="fecha" class="font-semibold">Filtrar por día:</label>
        <input type="date" name="fecha" id="fecha" value="{{ fecha|default:'' }}"
              class="border border-gray-300 rounded px-2 py-1">
        <button type="submit" class="px-3 py-1 bg-pink-400 text-white rounded-lg shadow hover:bg-pink-500 transition">Filtrar</button>
      </form>

      <a href="{% url 'visitas:registrar_visita' %}" 
         class="px-3 py-1 bg-pink-400 text-white rounded-lg shadow hover:bg-pink-500 transition">
        <i class="bi bi-person-plus-fill"></i> Registrar Nueva
      </a>
    </div>

    <div class="overflow-x-auto rounded-lg border border-pink-200 shadow-sm">
      <table class="w-full table-auto text-sm border-collapse">
        <thead class="bg-pink-100 text-black-700">
          <tr>
            <th class="border border-pink-200 px-4 py-2 text-left">Nombre</th>
            <th class="border border-pink-200 px-4 py-2 text-left">Apellido</th>
            <th class="border border-pink-200 px-4 py-2 text-left">RUT</th>
            <th class="border border-pink-200 px-4 py-2 text-left">Motivo</th>
            <th class="border border-pink-200 px-4 py-2 text-left">Hora Entrada</th>
            <th class="border border-pink-200 px-4 py-2 text-left">Hora Salida</th>
            
            <th class="border border-pink-200 px-4 py-2 text-left">Estado</th>
            <th class="border border-pink-200 px-4 py-2 text-left">Registró</th>
            
            <th class="border border-pink-200 px-4 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for v in visitas %}
          <tr class="hover:bg-pink-50 transition">
            <td class="border border-pink-100 px-4 py-2">{{ v.nombre }}</td>
            <td class="border border-pink-100 px-4 py-2">{{ v.apellido }}</td>
            <td class="border border-pink-100 px-4 py-2">{{ v.rut }}</td>
            <td class="border border-pink-100 px-4 py-2">{{ v.motivo }}</td>
            <td class="border border-pink-100 px-4 py-2">{{ v.hora_entrada|date:"d/m/Y H:i A" }}</td>
            <td class="border border-pink-100 px-4 py-2">
              {% if v.hora_salida %}
                {{ v.hora_salida|date:"d/m/Y H:i A" }}
              {% else %}
                <span class="text-pink-500 font-semibold">Pendiente</span>
              {% endif %}
            </td>

            <td class="border border-pink-100 px-4 py-2">
              {% if v.estado == 'FINALIZADA' %}
                <span class="px-2 py-1 bg-gray-200 text-gray-800 rounded-full text-xs">Finalizada</span>
              {% else %}
                <span class="px-2 py-1 bg-green-200 text-green-800 rounded-full text-xs">En Curso</span>
              {% endif %}
            </td>
            <td class="border border-pink-100 px-4 py-2">
              {{ v.registrado_por.username|default:'Sistema' }}
            </td>
            
            <td class="border border-pink-100 px-4 py-2 text-center">
              <div class="flex flex-col items-center gap-2">
                {% if not v.hora_salida %}
                  <a href="{% url 'visitas:marcar_salida' v.pk %}" 
                     class="flex items-center justify-center gap-1 w-20 px-2 py-1 bg-pink-400 text-white rounded-lg shadow hover:bg-pink-500 transition">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Salida</span>
                  </a>
                {% endif %}
                <a href="{% url 'visitas:editar_visita' v.pk %}" 
                  class="flex items-center justify-center gap-1 w-20 px-2 py-1 bg-blue-400 text-white rounded-lg shadow hover:bg-blue-500 transition">
                  <i class="bi bi-pencil-fill"></i>
                  <span>Editar</span>
                </a>
                <a href="{% url 'visitas:eliminar_visita' v.pk %}" 
                   onclick="return confirm('¿Estás seguro de eliminar la visita de {{ v.nombre }} {{ v.apellido }}?');"
                   class="flex items-center justify-center gap-1 w-20 px-2 py-1 bg-gray-400 text-white rounded-lg shadow hover:bg-gray-500 transition">
                  <i class="bi bi-trash3-fill"></i>
                  <span>Eliminar</span>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center py-6 text-gray-500">
              <i class="bi bi-exclamation-circle"></i> No hay visitas registradas
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-6 flex justify-center items-center gap-4">

      {% if visitas.has_previous %}
        <a href="?page=1{% if fecha %}&fecha={{ fecha }}{% endif %}" class="text-pink-500 hover:underline">&laquo; Primera</a>
        <a href="?page={{ visitas.previous_page_number }}{% if fecha %}&fecha={{ fecha }}{% endif %}" class="text-pink-500 hover:underline">
          <i class="bi bi-arrow-left"></i> Anterior
        </a>
      {% endif %}

      <span class="text-gray-700">
        Página {{ visitas.number }} de {{ visitas.paginator.num_pages }}
      </span>

      {% if visitas.has_next %}
        <a href="?page={{ visitas.next_page_number }}{% if fecha %}&fecha={{ fecha }}{% endif %}" class="text-pink-500 hover:underline">
          Siguiente <i class="bi bi-arrow-right"></i>
        </a>
        <a href="?page={{ visitas.paginator.num_pages }}{% if fecha %}&fecha={{ fecha }}{% endif %}" class="text-pink-500 hover:underline">Última &raquo;</a>
      {% endif %}
    </div>
  </div>
{% endblock %}